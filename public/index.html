<!DOCTYPE html>
<html>
<head>
    <title>Real-time Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="https://designsystem.bromcomcloud.com/demo/analytics/bromcom-ui/bromcom-ui.esm.js"></script>
    <link rel="stylesheet" href="https://designsystem.bromcomcloud.com/demo/analytics/bromcom-ui/bromcom-ui.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chart-container {
            width: 800px;
            margin: 50px auto;
        }
        .controls {
            text-align: center;
            margin: 20px;
        }
    </style>
</head>
<body>
    <!-- <div class="chart-container">
        <canvas id="myChart"></canvas>
        <div>
            <bcm-button>Yeni Veri Ekle</bcm-button>
        </div>
    </div>
    <div class="controls">
        <button onclick="addRandomData()">Yeni Veri Ekle</button>
        <button onclick="post()">Rastgele Veri Sil</button>
    </div> -->
    <div class="tw-w-full tw-max-w-[600px] tw-p-10">
        <bcm-tab-group id="tab-group" size="medium" active="1" color="blue">  <!--small | medium | large   default= 'medium'-->
            <bcm-tab-item>
              <bcm-tab-item-header>
                Form
              </bcm-tab-item-header>
              <div class="tw-p-4">
                <bcm-form id="user-form" validation name="user-form">
                    <div className="step-container">
                        <bcm-input full-width name="name" label="Name" required></bcm-input>
                        <bcm-input full-width name="surname" label="Surname" required></bcm-input>
                    </div>
                <bcm-button id="prev-button" onclick="submit()">Submit</bcm-button>
              </div>
            </bcm-form>
            </bcm-tab-item>
            <bcm-tab-item>
              <bcm-tab-item-header>
                Stepper
              </bcm-tab-item-header>
              <div class="tw-p-4">
                <bcm-stepper id="stepperWithDom" active="1" linear>
                    <bcm-step id="user-info" icon="fal fa-user" title="Person" description="Person information">
                        <bcm-form id="user-form" validation name="user-form">
                            <div className="step-container">
                                <bcm-input full-width name="name" label="Name" required></bcm-input>
                                <bcm-input full-width name="surname" label="Surname" required></bcm-input>
                            </div>
                        </bcm-form>
                    </bcm-step>
                    <bcm-step id="contact-info" icon="fal fa-phone-plus" disabled title="Contact" description="Enter Contact Information">
                        <bcm-form id="contact-form">
                            <div className="step-container">
                                <bcm-input full-width name="email" label="Email" type="email" required></bcm-input>
                                <bcm-input full-width name="phone" label="Phone" type="tel" required></bcm-input>
                            </div>
                        </bcm-form>
                    </bcm-step>
                    <bcm-step id="address-info" icon="fal fa-map-marker" title="Address" description="Enter Address Information">
                        <bcm-form id="address-form" validation>
                            <div className="step-container">
                                <bcm-input full-width name="street" label="Street" required></bcm-input>
                                <bcm-input full-width name="city" label="City" required></bcm-input>
                                <bcm-input full-width name="zip" label="ZIP" required></bcm-input>
                            </div>
                        </bcm-form>
                    </bcm-step>
                </bcm-stepper>
                <footer style="display:'flex'; flex-direction: 'row'; justify-content:'flex-start'; gap:'10px'">
                    <bcm-button id="prev-button" onclick="prev()">Prev</bcm-button>
                    <bcm-button id="next-button" onclick="next()">Next</bcm-button>
                </footer>
              </div>
             
       
        <bcm-button process-start-id="step1-start">Start Process</bcm-button>
        <bcm-button status="success" process-end-id="step1-end">End Process</bcm-button>
            </bcm-tab-item>
            <bcm-tab-item>
                <bcm-tab-item-header>
                    Tooltip
                  </bcm-tab-item-header>
                  <div class="tw-p-4">
                    <bcm-tooltip message="analytics tooltip" trigger="hover">
                        <bcm-button>Hover me</bcm-button>
                    </bcm-tooltip>
                  </div>
            </bcm-tab-item>
       </bcm-tab-group>

       <div class="tw-p-3">
        <canvas class="tw-max-w-[500px] tw-max-h-[500px]" id="myChart"></canvas>
       </div>
    </div>
    </div>
    <script>
        document.getElementById('tab-group').addEventListener('bcm-tab-change', (e) => {
            e.preventDefault();
            socket?.emit('changeTab', e.detail);
        });
      
         function submit() {
            const form = document.getElementById('user-form');
            form.submit();
        }

        // Socket.IO bağlantısı
        const socket = io({
            path: '/socket.io/',
            transports: ['websocket', 'polling'],
            secure: true,
            reconnection: true,
            reconnectionAttempts: Infinity,
            reconnectionDelay: 1000
        });

        // Chart.js yapılandırması
        const ctx = document.getElementById('myChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    label: 'Real-time Analytics',
                    data: [],
                    tension: 0.1,
                    backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
            ],
            borderWidth: 1
                }]
            },
            options: {
                responsive: true,
            }
        });

const tabs = {
    1: "Form",
    2: "Stepper",
    3: "Tooltip"
}
let activeTab;

const formData = [];
const stepperData = [];
const tooltipData = [];

let errorCounts = {
    name: 0,
    surname: 0
};


socket.on('initialData', (data) => {
    const formData = data.filter(item => item.eventType == 'submit');
    const stepperData = data.filter(item => item.eventType == 'PROCESS_END');
    const tooltipData = data.filter(item => item.eventType == 'TOOLTIP');

    activeTab ??= "Form";
    if(activeTab == "Form") {
        chart.label = 'User Form Field Errors';
        chart.data.labels = ['name', 'surname'];
        console.log(formData);
        formData.forEach(item => {
           item.errors.errorDetails.forEach(error => {
               if(error?.name) errorCounts.name++;
               if(error?.surname) errorCounts.surname++;
           });
        });
        chart.data.datasets[0].data = [errorCounts.name, errorCounts.surname];
    }

    if(activeTab == "Stepper") {
        chart.data.labels = ['Step 1', 'Step 2', 'Step 3'];
        chart.data.datasets[0].data.push(stepperData.length);
    }

    if(activeTab == "Tooltip") {
        chart.data.labels = ['Tooltip 1', 'Tooltip 2', 'Tooltip 3'];
        chart.data.datasets[0].data.push(tooltipData.length);
    }

    
    chart.update();
});

socket.on("tabChanged", (data) => {
    activeTab = tabs[data];
    socket.emit("getData");

});

socket.on('dataUpdated', () => {
    socket.emit("getData");
});


window.addEventListener('bcmAnalyticsEvent', (event) => {
    const payload = event.detail;
    socket.emit('updateData', payload);
});
    </script>
</body>
</html>

